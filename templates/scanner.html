<!DOCTYPE html>
<html>
<head>
    <title>Wedding QR Check-in</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            text-align: center;
            background-color: #f5f5f5;
        }

        h1 {
            margin-top: 15px;
        }

        #reader {
            width: 300px;
            margin: 20px auto;
        }

        #result {
            margin-top: 20px;
            font-size: 28px;
            font-weight: bold;
        }

        /* FULL SCREEN OVERLAY */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
            font-size: 50px;
            font-weight: bold;
            z-index: 9999;
            animation: fadeIn 0.4s ease-in-out;
        }

        .green {
            background-color: #28a745;
        }

        .orange {
            background-color: #ff9800;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>

<body>

<h1>Wedding Check-in</h1>

<div id="reader"></div>
<div id="result"></div>

<div id="overlay"></div>

<script>

let lastScannedId = null;
let lastScanTime = 0;
const cooldown = 2000;

function showOverlay(message, colorClass) {
    const overlay = document.getElementById("overlay");
    overlay.className = colorClass;
    overlay.innerHTML = message;
    overlay.style.display = "flex";

    setTimeout(() => {
        overlay.style.display = "none";
    }, 2000);
}

function onScanSuccess(decodedText) {

    const urlParams = new URL(decodedText).searchParams;
    const guestId = urlParams.get('id');
    if (!guestId) return;

    const now = Date.now();

    // Prevent double scan
    if (guestId === lastScannedId && (now - lastScanTime) < cooldown) {
        return;
    }

    lastScannedId = guestId;
    lastScanTime = now;

    fetch('/checkin', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({id: guestId})
    })
    .then(res => res.json())
    .then(data => {

        if(data.status === 'success') {
            showOverlay(`Welcome ${data.name} ✅`, "green");
        } 
        else if(data.status === 'already') {
            showOverlay(`${data.name} Already Checked-in ⚠️`, "orange");
        }

    })
    .catch(err => console.error(err));
}

var html5QrcodeScanner = new Html5QrcodeScanner(
    "reader",
    {
        fps: 10,
        qrbox: 250,
        rememberLastUsedCamera: true,
        showTorchButtonIfSupported: true
    }
);

html5QrcodeScanner.render(onScanSuccess);

</script>

</body>
</html>
